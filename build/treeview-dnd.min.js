/*https://github.com/empty125/treeview-dnd.js; @license http://www.apache.org/licenses/LICENSE-2.0 */
define(function(d,c,e){var b=d("jquery");var a={_doc:b(window.document),_initd:false,_items:[],_lastHit:"",_lastSelected:"",_draghoverCls:"",_copy:"",_target:"",_appendType:"",_clsHandlers:{},_timer:"",dropDisableCls:"dropdisabled",_dropCls:[],_countId:1,_newHtml:['<li class="edit-element expand" {#attrs}>','<div class="{#cls} expand-header level{#level}-header">','<div class="item-label">{#icon}<span class="title">{#title}</span></div>','<div class="ct-controls">{#controls}</div>',"</div>",'<div class="insert" style=""></div>','<ul style="display:{#expand}">{#children}</ul>',"</li>"].join(""),_dragoffset:{},initDrop:function(g){var f=this;f._dropCls.push(g);b(g).each(function(h){var j=b(this);f.setArea(j);j.data("dnd_id",f._countId++);f._items.push(j)})},setArea:function(g){var h=g.offset();var f=g.outerHeight();g.area={top:h.top,bottom:h.top+g.outerHeight(),left:h.left,right:h.left+g.outerWidth(),middle:h.top+f/2};g.dndparent=g.parent();g.dndlevel=g.dndparent.attr("data-level")||1;return g},setDisabled:function(g){if(!g){return false}var f=this._getHandle(g);if(!f){return false}if(f.targetCls){g.parent().addClass(f.targetCls)}if(f.dropabled){g.find(this._dropCls.join(",")).addClass(this.dropDisableCls)}return g},setEnabled:function(g){if(!g){return false}var f=this._getHandle(g);if(!f){return false}if(f.targetCls){g.parent().removeClass(f.targetCls)}if(f.dropabled){g.find(this._dropCls.join(",")).removeClass(this.dropDisableCls)}return g},updateArea:function(g){var f=this;if(!g){g=0}else{g=parseInt(g);g=isNaN(g)?0:g}for(;g<f._items.length;g++){f.setArea(f._items[g]);f._items[g].data("dnd_id",g+1)}f._countId=f._items.length==0?1:f._items.length},removeItem:function(g){var f=g.data("dnd_id");g.parent().detach();if(f){this._items.splice(f-1,1);this.updateArea(f-1)}},addItem:function(f,h){if(!f||!h){return false}h.attr("data-group",f);var g=this._getHandle(h);if(h.length>0&&g){this.setArea(h);h.data("dnd_id",this._countId++);this._bindDrag(h,g);this._items.push(h);this.bindExEvent(h)}},setCurrentItem:function(f,g){this._copy=g;this._target=this.setArea(f);this.setDisabled(this._target)},checkCrash:function(g,f){return g.middle<=f.bottom&&g.middle>=f.top&&!(g.right<f.left||g.left>f.right)},checkDropEnable:function(f){if(!f||!f.dndlevel){return false}if(this._target.data("dnd_id")==f.data("dnd_id")||f.hasClass(this.dropDisableCls)){return false}return true},checkHit:function(){var f=this;f.setArea(f._copy);var g=f._getHandle(f._target);if(!g){return false}if(f._lastHit&&f._draghoverCls){f._lastHit.removeClass(f._draghoverCls);f._lastHit=null}for(i=0;i<f._items.length;i++){if(f.checkCrash(f._copy.area,f._items[i].area)){if(f._lastHit&&f._draghoverCls){f._lastHit.removeClass(f._draghoverCls)}if(f.checkDropEnable(f._items[i])){switch(f._items[i].dndlevel-f._target.dndlevel){case 0:f._appendType="after";break;case -1:f._appendType="insert";break;default:f._lastHit=null;continue}f._items[i].addClass(g.draghoverCls);f._draghoverCls=g.draghoverCls;f._lastHit=f._items[i];break}}}},updateItem:function(){var f=this._getHandle(this._target);if(!f){return false}if(this._target&&this._lastHit){if(b.type(f.drop)!="function"){f.drop=this._defaultDrop}f.drop.call(this,this._appendType,this._target,this._lastHit);this.updateArea(Math.min(this._target.data("dnd_id"),this._lastHit.data("dnd_id"))-1)}if(this._lastHit&&this._draghoverCls){this._lastHit.removeClass(this._draghoverCls)}this.setEnabled(this._target);this._lastHit=null;this._target=null;this._draghoverCls=""},dragabled:function(f,g){if(!f||!g){return}this._clsHandlers[f]=g;if(g.dropabled){this.initDrop(f)}var h=b(f).attr("data-group",f);this._bindDrag(h,g);if(!this._initd){this._bindDocEvent();this._initd=true}if(g.events){this.bindExEvent(h,g.events)}},getDropItems:function(){return this._items},bindExEvent:function(j,g){var h=this._getHandle(j);if(!h||!h.events){return}if(!g){g=h.events}for(var f in g){if(b.type(g[f])=="function"){j.bind(f,{dnd:this,handle:h},g[f])}}},_defaultDrop:function(f,h,g){switch(f){case"after":g.parent().after(h.parent());break;case"insert":g.siblings("ul").append(h.parent());break}},_bindDrag:function(g,f){g.bind("mousedown",{dnd:this,handle:f},function(j){if(j.button===2){return false}j.stopPropagation();j.preventDefault();var k=b(this);var h=j.data.dnd;h._timer=setTimeout(function(){if(h._timer){clearTimeout(h._timer);h._timer=null}var m=k.clone(false);var l=k.position();var n={X:j.clientX-l.left,Y:j.clientY-l.top};k.parent().append(m);m.css({position:"absolute",width:k.width(),height:k.height(),"z-index":9999}).hide();if(j.data.handle.draggingCls){m.addClass(j.data.handle.draggingCls)}h._dragoffset=n;if(b.type(f.drag)=="function"){f.drag.call(j.data.dnd)}h.setCurrentItem(k,m)},100)})},_bindDocEvent:function(){this._doc.bind("mousemove",{dnd:this},function(g){g.stopPropagation();g.preventDefault();var f=g.data.dnd;if(f._timer){clearTimeout(f._timer);f._timer=null}if(!f._copy){return}var h=f._dragoffset;f._copy.css({top:g.clientY-h.Y,left:g.clientX-h.X}).show();f.checkHit()}).bind("mouseup",{dnd:this},function(g){g.stopPropagation();g.preventDefault();var f=g.data.dnd;if(f._timer){clearTimeout(f._timer);f._timer=null;return false}if(!f._copy){return}f._copy.detach();f.updateItem()})},_getHandle:function(f){if(!f){return false}return this._clsHandlers[f.attr("data-group")]},destory:function(){}};a.levelsAttr=[{icon:'<span class="label-icon label-icon-1"></span>',title:"新的一级节点",cls:"item-labelbox",expand:true},{icon:'<span class="label-icon label-icon-2 expand-icon"></span>',title:"新的二级节点",cls:"item-labelbox",expand:true},{icon:'<span class="label-icon label-icon-3"></span>',title:"新的三级节点",cls:"item-labelbox",expand:true},{icon:'<span class="label-icon label-icon-4"></span>',title:"新的四级节点",cls:"item-labelbox",expand:true}];a.createNewLevel=function(m,f,k){k=k||false;f=f||{};var l={},j=1;if(!isNaN(m)){if(!this.levelsAttr[m-1]){return false}for(h in f){l["data-"+h]=f[h]}l["data-level"]=m;j=m;m=this.levelsAttr[m-1]}else{if(!f.level){return false}var l=[],h="";for(h in f){l.push("data-"+h+'="'+f[h]+'"')}j=f.level;m.attrs=l.join(" ")}m.level=j;m.expand=m.expand===undefined||m.expand?"block":"none";delete f;var g=a._newHtml.replace(/\{\#(\w+)\}/g,function(n,o){if(m[o]){return m[o]}else{return""}});return !k?b(g).attr(l):g};a.render=function(k,m,f){if(!k){return false}if(f&&f.controls){this._newHtml=this._newHtml.replace("{#controls}",f.controls)}var h=0,l=[],j="";for(;h<k.length;h++){j=this._render(k[h],1);if(j){l.push(j)}}var g="<ul>"+l.join("")+"</ul>";if(!m){return g}m.html(g)};a._render=function(k,m){if(!k||!m){return""}var h="",g=0,f={},l=[];k=b.extend({},a.levelsAttr[m-1],k);for(h in k){if(h=="children"&&k[h]){for(g=0;g<k[h].length;g++){l.push(a._render(k[h][g],m+1))}k.children=l.join("")}if(h=="attrs"){f=k[h]}}f.level=m;return a.createNewLevel(k,f,true)};e.exports=a});
